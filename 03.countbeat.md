# CountBeat만들기



## Create a new beat

#### 준비

* go 환경 

```
$ go version
go version go1.17 linux/amd64

$ env | grep  GO
GOROOT=/usr/local/go
GOPATH=/home/jhyunlee/go

export PATH=$PATH:${GOPATH}/bin
```

* python >=3.7

```
$ sudo apt-get install python3-venv
```

* Mage 설치

```
$ go get -u -d github.com/magefile/mage
$ cd $GOPATH/src/github.com/magefile/mage
$ go run bootstrap.go
```

#### Custom Beat 생성

##### 1. Elastic beat

```
$ mkdir -p ${GOPATH}/src/github.com/elastic
$ git clone https://github.com/elastic/beats ${GOPATH}/src/github.com/elastic/beats
$ cd ${GOPATH}/src/github.com/elastic/beats
$ git checkout 7.11
```

##### 2. customBeat 생성

```
$ mkdir ${GOPATH}/src/github.com/{user}
$ cd ${GOPATH}/src/github.com/{user}
$ mage GenerateCustomBeat
```

##### 3. build

```
$ go mod init
$ go mod vendor
$ go get -u
$ go build -mod vendor main.go
$ ./countbeat -e -d "*"
```





https://www.elastic.co/guide/en/beats/devguide/7.11/compiling-and-running.html



#### Custom beat 구조

##### 

![Beat overview architecture](D:\Code\dev\img\beat_overview.png)

##### 전달항목

* event에는 JSON (go type map[string]interface{})  내용이 전달되야 한다.
* 필수항목은 : @timestamp, type 

```yaml
{
  "@timestamp": "2016-07-13T21:33:58.355Z",
  "beat": {
    "hostname": "mar.local",
    "name": "mar.local"
  },
  "directory": false,
  "filename": "winlogbeat.yml",
  "filesize": 2895,
  "modtime": "2016-07-13T20:56:21.000Z",
  "path": "./vendor/github.com/elastic/beats/winlogbeat/winlogbeat.yml",
  "type": "lsbeat"
}

{
  "@timestamp": "2016-07-13T21:33:58.354Z",
  "beat": {
    "hostname": "mar.local",
    "name": "mar.local"
  },
  "directory": true,
  "filename": "system",
  "filesize": 238,
  "modtime": "2016-07-13T20:56:21.000Z",
  "path": "./vendor/github.com/elastic/beats/winlogbeat/tests/system",
  "type": "lsbeat"
}
```

